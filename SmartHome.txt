import datetime

usuariosRegistrados = {}
habitacionesUsuarios = {}
dispositivosUsuarios = {}


# Funciones

def usuarioExistente(usuariosRegistrados):
    usuarioNombre = input("\nIntroduzca su nombre de usuario: ")
    if usuarioNombre in usuariosRegistrados.keys():       
        pin = input("Introduzca su pin: ")
        if usuariosRegistrados[usuarioNombre]['pin'] == int(pin):
            print("\n ¡Hola " + usuarioNombre + "!\n")
            print("Tu correo electrónico registrado es: ")
            print(usuariosRegistrados[usuarioNombre]['correo'])
            return usuarioNombre
        else:
            print("El pin proporcionado no corresponde con el usuario")
    else:
        print("\nMENSAJE: El usuario no existe. Intente de nuevo o ingrese nuevo usuario\n")

def nuevoUsuario(usuariosRegistrados, habitacionesUsuarios):
    nuevoUsuario = input("\nIngrese el nombre de usuario: ")
    correo = input("Ingrese el correo electrónico: ")
    pin = input("Ingrese el pin: ")
    usuariosRegistrados[nuevoUsuario] = {'correo': correo, 'pin': int(pin)}
    habitacionesUsuarios[nuevoUsuario] = [] 
    print("\nRegistro exitoso. Ahora puede iniciar sesión.")

def agregarHabitacion(nombreHabitacion, habitacionesUsuarios, usuarioActual):
    if nombreHabitacion not in habitacionesUsuarios[usuarioActual]:
        habitacionesUsuarios[usuarioActual].append(nombreHabitacion)
        print("Habitación agregada correctamente.")
    else:
        print("La habitación ya existe.")

def mostrarHabitaciones(habitacionesUsuarios, usuarioActual):
    print("\nHabitaciones de", usuarioActual)
    if habitacionesUsuarios[usuarioActual]:
        for habitacion in habitacionesUsuarios[usuarioActual]:
            print("-", habitacion)
    else:
        print("No se han agregado habitaciones.")

def agregarDispositivo(nombreHabitacion, dispositivosUsuarios, habitacionesUsuarios, usuarioActual):
    if not habitacionesUsuarios.get(usuarioActual):
        print("\nAún no ha registrado ninguna habitación. Por favor, agregue una habitación primero.")
        return
    
    if nombreHabitacion in habitacionesUsuarios[usuarioActual]:
        nombreDispositivo = input("Ingrese el nombre del dispositivo: ")
        if usuarioActual not in dispositivosUsuarios:
            dispositivosUsuarios[usuarioActual] = {}

        if nombreHabitacion not in dispositivosUsuarios[usuarioActual]:
            dispositivosUsuarios[usuarioActual][nombreHabitacion] = []

        for dispositivo in dispositivosUsuarios[usuarioActual][nombreHabitacion]:
            if dispositivo['nombre'] == nombreDispositivo:
                print("Un dispositivo con ese nombre ya existe en la habitación. Por favor, ingrese otro nombre.")
                return

        estado = input("¿El dispositivo está encendido? (si/no): ").lower()
        dispositivo = {'nombre': nombreDispositivo, 'estado': estado}
        if estado == "si":
            dispositivo['fechaEncendido'] = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        dispositivosUsuarios[usuarioActual][nombreHabitacion].append(dispositivo)
        print("Dispositivo agregado correctamente.")
    else:
        print("La habitación especificada no existe.")

def mostrarDispositivosHabitacion(nombreHabitacion, dispositivosUsuarios, habitacionesUsuarios, usuarioActual):
    if not habitacionesUsuarios.get(usuarioActual):
        print("\nAún no ha registrado ninguna habitación. Por favor, agregue una habitación primero.")
        return

    if nombreHabitacion in habitacionesUsuarios[usuarioActual]:
        if nombreHabitacion in dispositivosUsuarios.get(usuarioActual, {}):
            dispositivos = dispositivosUsuarios[usuarioActual][nombreHabitacion]
            if dispositivos:
                print("\nDispositivos en", nombreHabitacion, ":")
                for dispositivo in dispositivos:
                    estado = "Encendido" if dispositivo['estado'] == "si" else "Apagado"
                    print(f"- {dispositivo['nombre']}: {estado}", end='')
                    if estado == "Encendido":
                        print(f", Encendido desde: {dispositivo['fechaEncendido']}")
                    else:
                        print()
            else:
                print("No hay dispositivos en la habitación", nombreHabitacion)
        else:
            print("No hay dispositivos en la habitación", nombreHabitacion)
    else:
        print("La habitación especificada no existe.")

# Principal

def main():

    while True: 
        print("\n Bienvenido a SmartHome.\n")
        print("¿Qué deseas hacer?")
        print("1. Ingresar con tu usuario")
        print("2. Agregar usuario")
        print("3. Salir")
        opcion = input("Por favor seleccione una opción: ")
        
        if opcion == "1":
            usuarioActual = usuarioExistente(usuariosRegistrados)
            if usuarioActual:
                menu_usuario(usuarioActual)
        
        elif opcion == "2":
            nuevoUsuario(usuariosRegistrados, habitacionesUsuarios)
        
        elif opcion == "3":
            print("\nSesión finalizada. ¡Hasta luego!")
            break
        
        else:
            print("\nSu selección no es compatible. Intente de nuevo")

def menu_usuario(usuarioActual):
    opcionUsuario = "1"
    while opcionUsuario != "5":
        print("\nMENU DEL USUARIO")
        print("1. Agregar habitación.")
        print("2. Ver habitaciones registradas.")
        print("3. Agregar dispositivo.")
        print("4. Ver dispositivos de una habitación.")
        print("5. Salir")
        opcionUsuario = input("Por favor seleccione una opción: ")

        if opcionUsuario == "1":
            nombreHabitacion = input("\nIngrese el nombre de la habitación que desea agregar: ")
            agregarHabitacion(nombreHabitacion, habitacionesUsuarios, usuarioActual)
        elif opcionUsuario == "2":
            mostrarHabitaciones(habitacionesUsuarios, usuarioActual)
        elif opcionUsuario == "3":
            nombreHabitacion = input("\nIngrese el nombre de la habitación donde agregará el dispositivo: ")
            agregarDispositivo(nombreHabitacion, dispositivosUsuarios, habitacionesUsuarios, usuarioActual)
        elif opcionUsuario == "4":
            nombreHabitacion = input("\nIngrese el nombre de la habitación para ver los dispositivos: ")
            mostrarDispositivosHabitacion(nombreHabitacion, dispositivosUsuarios, habitacionesUsuarios, usuarioActual)
        elif opcionUsuario == "5":
            print("\nVolviendo a menú principal...")


#Ejecucion
            
main()


#Funciones Generales 
def crear_cerradura(nombre, estado="cerrado", pin="1234"):
    return {"nombre": nombre, "estado": estado, "pin": pin}

def cambiar_pin(cerradura, pin_actual, nuevo_pin):
    if len(nuevo_pin) > 4:
        print("¡Error! El pin no puede tener más de 4 dígitos.")
    elif pin_actual == cerradura["pin"]:
        cerradura["pin"] = nuevo_pin
        print("¡El pin ha sido cambiado con éxito!")
    else:
        print("¡Pin incorrecto! No se puede cambiar el pin.")

def abrir_cerradura(cerradura, pin):
    if pin == cerradura["pin"]:
        cerradura["estado"] = "abierto"
        print(f"La cerradura {cerradura['nombre']} ha sido abierta.")
    else:
        print("¡Pin incorrecto! No se puede abrir la cerradura.")

def cerrar_cerradura(cerradura):
    cerradura["estado"] = "cerrado"
    print(f"La cerradura {cerradura['nombre']} ha sido cerrada.")

def menu_cerraduras(cerraduras):
    while True:
        print("\n--- Menú de Cerraduras ---")
        for i, cerradura in enumerate(cerraduras, start=1):
            print(f"{i}. {cerradura['nombre']}: {cerradura['estado']}")

        print("0. Salir")

        opcion = input("Seleccione una cerradura para cambiar su estado: ")

        if opcion == '0':
            break
        elif opcion.isdigit() and 0 < int(opcion) <= len(cerraduras):
            cerradura_seleccionada = cerraduras[int(opcion) - 1]

            print(f"\nOperando la cerradura {cerradura_seleccionada['nombre']}:")
            print("1. Abrir cerradura")
            print("2. Cerrar cerradura")
            print("3. Cambiar pin")

            accion = input("Seleccione una acción: ")

            if accion == '1':
                pin = input("Ingrese el pin: ")
                abrir_cerradura(cerradura_seleccionada, pin)
            elif accion == '2':
                cerrar_cerradura(cerradura_seleccionada)
            elif accion == '3':
                pin_actual = input("Ingrese el pin actual: ")
                nuevo_pin = input("Ingrese el nuevo pin: ")
                cambiar_pin(cerradura_seleccionada, pin_actual, nuevo_pin)
            else:
                print("¡Opción inválida! Inténtelo de nuevo.")
        else:
            print("¡Opción inválida! Inténtelo de nuevo.")

# Creamos las cerraduras
cerraduras = [
    crear_cerradura("Salida Principal"),
    crear_cerradura("Salida Trasera"),
    crear_cerradura("Balcon")
]

# Ejecutamos el menú de cerraduras
menu_cerraduras(cerraduras)


